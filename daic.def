Bootstrap: docker
From: condaforge/miniforge3:latest

%files
    env.yml /env.yml
    requirements.txt /requirements.txt

%post

    # Install optional packages and programs
    # Need DEBIAN_FRONTEND=noninteractive to not get stuck during build
    # Then clean up to keep the container small

    apt-get update && \
        DEBIAN_FRONTEND=noninteractive TZ=Europe/Amsterdam \
        apt-get install -y --no-install-recommends libopenmpi-dev curl wget vim watch procps ncdu tree && \
        apt-get clean && rm -rf /var/lib/apt/lists/*

    # Create a new Conda environment with JupyterLab
    mamba env create --quiet -y --file /env.yml

    mamba install -n tt-env -y pytorch=2.6.0 torchvision=0.21.0 torchaudio=2.6.0 pytorch-cuda=11.8 -c pytorch -c nvidia -c pyg
    mamba run -n tt-env pip install --no-cache-dir -r requirements.txt
    mamba run -n tt-env pip install --no-cache-dir pytorch-frame sentence_transformers relbench strictfire ml-dtypes

    # Clean up
    apt-get clean && rm -rf /var/lib/apt/lists/*
    mamba clean --all -y

    # Now add the script to activate the Conda environment
    echo '. "/opt/conda/etc/profile.d/conda.sh"' >> $APPTAINER_ENVIRONMENT
    echo 'conda activate tt-env' >> $APPTAINER_ENVIRONMENT